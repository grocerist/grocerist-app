{% set leaflet_css = True %}
{% set tabulator_css = True %}
{% extends "templates/partials/base.j2" %}
{% block scriptHeader %}
{% include "templates/partials/tabulator.j2" %}
{% endblock scriptHeader %}

{% block content %}
<div class="container subpage">
    <h1 class="text-center">
        {% with parent_page = "goods" %}
        {% include "templates/partials/link_to_top.j2" %}
        {% endwith %}
        {{ object.name }}
    </h1>
    <div class="row">
        <div class="col">
            {% if object.english_names or object.spelling_variations_and_synonyms %}
            <h3><i class="bi bi-journal-text" aria-hidden="true"></i> Vocabulary details</h3>
            <dl class="ms-4">
                {% if object.english_names %}
                <dt>Translation</dt>
                <dd class="ms-2">{{ object.english_names }}</dd>
                {% endif %}
                {% if object.spelling_variations_and_synonyms %}
                <dt>Spelling variations and synonyms</dt>
                {% for variation in object.spelling_variations_and_synonyms.split(',') %}
                <dd class="ms-2">{{ variation.strip() }}</dd>
                {% endfor %}
                {% endif %}
            </dl>
            {% endif %}

            {% if object.notes %}
            <h2><i class="bi bi-info-circle" aria-hidden="true"></i> Description</h2>
            <p class="ms-4">{{ object.notes }}</p>
            {% endif %}

            {% if object.has_category%}
            <h2><i class="bi bi-boxes" aria-hidden="true"></i> Categories</h2>
            <ul>
                {% for x in object.has_category %}
                <li><a href="category__{{ x.id }}.html">{{ x.value }}</a></li>
                {% endfor %}
            </ul>
            {% endif %}

            {% if object.documents%}
            <h2><i class="bi bi-archive" aria-hidden="true"></i> Documents</h2>
            <ul>
                {% for x in object.documents %}
                <li><a href="document__{{ x.id }}.html">{{ x.value }}</a></li>
                {% endfor %}
            </ul>
            {% endif %}



            

            {% if object.price_per_document %}
            <h2><i class="bi bi-cash-stack" aria-hidden="true"></i> Price Information</h2>

            <div id="prices-table"></div>

            <script id="prices-data" type="application/json">
                {{object | tojson | safe}}
            </script>


            <!-- Updated JavaScript for Tabulator -->
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    // Get JSON data from the hidden script tag
                    let tableDataElement = document.getElementById("prices-data");
                    if (!tableDataElement) {
                        console.error("Tabulator data element not found.");
                        return;
                    }

                    let tableData = JSON.parse(tableDataElement.textContent);

                    // Define table columns (matching prices.js)
                    const columnDefinitions = [
                        {
                            title: "Document",
                            field: "price_per_document.document.0.value",
                            formatter: function (cell) {
                                let doc = cell.getData().document[0];
                                return doc ? `<a href="document__${doc.id}.html">${doc.value}</a>` : "N/A";
                            }
                        },
                        {
                            title: "Year",
                            field: "documents",
                            formatter: "plaintext",
                            mutator: function (value) {
                                console.log(value)
                                if (Array.isArray(value) && value.length > 0) {
                                    for (let doc of value) {
                                        if (doc.iso_date) {
                                            return doc.iso_date.slice(0, 4); // Extract year from iso_date
                                        }
                                    }
                                } else {return "blue";}
                                 // Default if no valid year found
                            }
                        },
                        {
                            title: "Price",
                            field: "price",
                            formatter: "plaintext",
                            mutator: function (value) {
                                return value ?? "N/A";
                            },
                        },
                        {
                            title: "Unit",
                            field: "unit.value",
                            formatter: "plaintext",
                            mutator: function (value) {
                                return value ?? "N/A";
                            },
                        },
                        {
                            title: "Amount",
                            field: "amount_of_units",
                            formatter: "plaintext",
                            mutator: function (value) {
                                return value ?? "N/A";
                            },
                        },
                        {
                            title: "Total Value",
                            field: "total_value",
                            formatter: "plaintext",
                            mutator: function (value) {
                                return value ?? "N/A";
                            },
                        },
                    ];

                    // Initialize Tabulator
                    new Tabulator("#prices-table", {
                        data: tableData,
                        layout: "fitColumns",
                        columns: columnDefinitions,
                        initialSort: [{ column: "Year", dir: "asc" }],
                    });
                });
            </script>
            {% endif %}

        </div>

        <div class="col">
            <h2><i class="bi bi-map" aria-hidden="true"></i> Map</h2>
            <div id="map" style="height: 600px;" />
        </div>
    </div>
</div>
{% endblock content %}
{% block scripts2 %}
{% if object.documents %}
{% include "templates/partials/leaflet.j2" %}
<script>
    const icon = "bi bi-basket3-fill"

    // tojson filter is used to keep the data in json format
    // e.g. preventing the null values from being converted to None during processing
    const doc_list = {{ object.documents | tojson | safe }};

    const { map, layerGroups } = createMap({ layerControl: true });

    // create markers for each document
    for (let i = 0; i < doc_list.length; i++) {
        const doc = doc_list[i];
        const year = getYearFromISODate(doc.iso_date);
        if (doc.lat && doc.long) {
            const yearText = year ? `in ${year}` : '';
            const markerData = {
                lat: doc.lat,
                long: doc.long,
                year: year,
                popupContent: `<p>Mentioned in document <br>
            <strong><a href="document__${doc.id}.html">${doc.value}</a></strong><br>
            ${yearText}</p>`,
                icon: icon,
            };
            const { marker, layerName } = createMarker(markerData, true);
            marker.addTo(layerGroups[layerName]);
        }
    }
</script>
{% endif %}
{% endblock scripts2 %}